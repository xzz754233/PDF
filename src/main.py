import os
import sys
import markdown
from xhtml2pdf import pisa
from crewai import Agent, Task, Crew, Process
from crewai.tools import BaseTool
from crewai_tools import SerperDevTool
from pydantic import BaseModel, Field
from typing import Type
from dotenv import load_dotenv

load_dotenv()

class PDFGeneratorInput(BaseModel):
    """Input schema for PDFGeneratorTool."""
    output_filename: str = Field(..., description="The final PDF filename (e.g., 'lite_output/final_report.pdf').")

class PDFGeneratorTool(BaseTool):
    name: str = "Generate PDF Report"
    description: str = "Reads the generated MD files (spec, tech, code) and compiles them into a PDF."
    args_schema: Type[BaseModel] = PDFGeneratorInput

    def _run(self, output_filename: str) -> str:
        try:
            os.makedirs(os.path.dirname(output_filename), exist_ok=True)
            
            # --- 1. CSS 樣式優化 ---
            # 針對 xhtml2pdf 優化：使用背景色、邊框、等寬字型來美化程式碼
            css_style = """
            <style>
                @page { size: A4; margin: 2cm; }
                body { font-family: Helvetica, sans-serif; font-size: 10pt; line-height: 1.6; color: #333; }
                
                h1 { color: #2c3e50; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; margin-top: 30px; }
                h2 { color: #e67e22; margin-top: 25px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
                h3 { color: #34495e; margin-top: 20px; font-weight: bold; }
                
                ul { margin-bottom: 10px; }
                li { margin-bottom: 5px; }
                
                /* 程式碼區塊核心樣式 */
                pre {
                    font-family: "Courier New", Courier, monospace;
                    font-size: 9pt;
                    background-color: #f5f7f9;
                    border: 1px solid #e1e4e8;
                    border-radius: 5px;
                    padding: 15px;
                    margin: 15px 0;
                    white-space: pre-wrap; /* 關鍵：保留換行 */
                    color: #24292e;
                }
                
                /* 讓行內代碼也有樣式 */
                code {
                    font-family: "Courier New", Courier, monospace;
                    color: #e83e8c;
                    background-color: #fdf2f6;
                    padding: 2px 4px;
                    border-radius: 3px;
                }
                
                /* 重置 pre 裡面的 code 樣式，避免雙重背景 */
                pre code {
                    color: inherit;
                    background-color: transparent;
                    padding: 0;
                }
            </style>
            """
            
            combined_content = "# Project Final Report\n\nGenerated by SaaS Launchpad Crew\n\n"
            
            # --- 2. 檔案讀取與合併 ---
            
            # 讀取 Spec (Phase 1)
            if os.path.exists("lite_output/1_spec.md"):
                with open("lite_output/1_spec.md", "r", encoding="utf-8") as f:
                    combined_content += f"\n\n---\n\n{f.read()}"

            # 讀取 Tech Stack (Phase 2)
            if os.path.exists("lite_output/2_tech_stack.md"):
                with open("lite_output/2_tech_stack.md", "r", encoding="utf-8") as f:
                    combined_content += f"\n\n---\n\n{f.read()}"

            # 讀取 Skeleton Code (Phase 3) - [關鍵邏輯修正]
            code_path = "lite_output/3_mvp_skeleton.md"
            if os.path.exists(code_path):
                with open(code_path, "r", encoding="utf-8") as f:
                    raw_code = f.read().strip()
                
                # 檢查 Agent 是否已經乖乖加上了 ```python
                if "```" not in raw_code:
                    # 如果全文都沒有 code block 標記，我們強制包起來！
                    # 使用 \n 確保換行，避免 markdown 解析失敗
                    formatted_code = f"\n# Phase 3: MVP Skeleton Code\n\n```python\n{raw_code}\n```"
                else:
                    # 如果已經有標記，我們假設 Agent 做對了，直接貼上
                    formatted_code = f"\n\n---\n\n{raw_code}"
                
                combined_content += formatted_code

            # --- 3. 轉換與生成 ---
            # extensions=['fenced_code'] 是必要的，它讓 python-markdown 認得 ```
            html_content = markdown.markdown(combined_content, extensions=['fenced_code', 'codehilite'])
            full_html = f"<html><head>{css_style}</head><body>{html_content}</body></html>"

            with open(output_filename, "wb") as pdf_file:
                pisa_status = pisa.CreatePDF(full_html, dest=pdf_file)

            if pisa_status.err:
                return f"Error creating PDF: {pisa_status.err}"
            
            # 清理中間產物
            files_to_clean = ["lite_output/1_spec.md", "lite_output/2_tech_stack.md", "lite_output/3_mvp_skeleton.md"]
            for fpath in files_to_clean:
                if os.path.exists(fpath):
                    try:
                        os.remove(fpath)
                    except:
                        pass

            return f"Successfully compiled PDF report at: {output_filename}"
            
        except Exception as e:
            return f"Exception during PDF creation: {str(e)}"

# --- Main Crew Logic ---

def run_lite_crew(inputs=None):
    print("=== Initializing SaaS Launchpad Crew (Lite Version) ===")
    
    search_tool = SerperDevTool()
    pdf_tool = PDFGeneratorTool()

    # --- Agents ---
    
    analyst = Agent(
        role='Lead Product Analyst',
        goal='Analyze the user idea and produce a clear PRD.',
        backstory="Expert at translating vague ideas into logical docs.",
        tools=[search_tool],
        verbose=False,
        memory=True
    )

    resource_hunter = Agent(
        role='Tech Resource Scout',
        goal='Find suitable Python libraries and APIs.',
        backstory="Familiar with Python ecosystem.",
        tools=[search_tool],
        verbose=False,
        memory=True
    )

    architect = Agent(
        role='Senior Technical Architect',
        goal='Produce the MVP code structure and compile the PDF.',
        backstory="Excels at building functional MVPs.",
        tools=[pdf_tool], 
        verbose=False,
        memory=True
    )

    # --- Tasks ---
    
    task_analysis = Task(
        description=(
            "Analyze the user's idea: '{task}'.\n"
            "Define features, risks, and competitors."
        ),
        expected_output="A Markdown document containing the analysis.",
        agent=analyst,
        output_file="lite_output/1_spec.md" 
    )

    task_resources = Task(
        description=(
            "Recommend tech stack based on the spec."
        ),
        expected_output="A Markdown list of tools and APIs.",
        agent=resource_hunter,
        output_file="lite_output/2_tech_stack.md"
    )

    # [Task 修正] 更嚴格的指令，要求純代碼輸出
    task_coding = Task(
        description=(
            "Write the core 'main.py' skeleton code.\n"
            "CRITICAL FORMATTING INSTRUCTIONS:\n"
            "1. Output ONLY the code.\n"
            "2. Do NOT add introductory text like 'Here is the code'.\n"
            "3. Ensure the code is valid Python.\n"
            "4. Wrap the code in markdown code blocks: ```python ... ```"
        ),
        expected_output="Python code skeleton in Markdown format.",
        agent=architect,
        output_file="lite_output/3_mvp_skeleton.md"
    )

    task_report = Task(
        description=(
            "The previous tasks have already saved the files.\n"
            "You just need to call the 'Generate PDF Report' tool.\n"
            "Set output_filename to 'lite_output/final_report.pdf'.\n"
            "In your final answer, just say 'DONE' and nothing else."
        ),
        expected_output="The word 'DONE'.",
        agent=architect
    )

    # --- Crew ---
    crew = Crew(
        agents=[analyst, resource_hunter, architect],
        tasks=[task_analysis, task_resources, task_coding, task_report],
        process=Process.sequential,
        verbose=False
    )

    return crew

if __name__ == "__main__":
    # Local Testing Logic
    print("## Local Testing Mode ##")
    user_idea = input("\nPlease enter your project idea: ")
    if not user_idea: sys.exit()
    
    my_crew = run_lite_crew()
    test_inputs = {"task": user_idea}
    
    print(f"\n[System] Kicking off crew...\n")
    result = my_crew.kickoff(inputs=test_inputs)
    print("\n[Done] Check the lite_output folder.")